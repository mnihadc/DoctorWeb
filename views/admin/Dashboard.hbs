<div class="container">
    <div class="search-container">
        <input type="text" placeholder="Search users...">
        <button onclick="togglePopup()" style="color: aliceblue;">Create User</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            {{#each users}}
            <tr id="user-{{this._id}}">
                <td>{{this._id}}</td>
                <td>{{this.username}}</td>
                <td>{{this.email}}</td>
                <td><button class="edit"
                        onclick="openEditPopup('{{this._id}}', '{{this.username}}', '{{this.email}}')">Edit</button>
                </td>
                <td><button class="delete" onclick="deleteUser('{{this._id}}')">Delete</button></td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<div class="overlay" id="overlay"></div>
<div class="popup" id="popup">
    <h2 id="popupTitle" style="color: aliceblue;">Create User</h2>
    <input type="text" id="usernameInput" placeholder="Username"><br>
    <input type="email" id="emailInput" placeholder="Email"><br>
    <button onclick="addOrUpdateUser()">Save</button>
    <button onclick="togglePopup()">Cancel</button>
</div>

<script>
    let editingUserId = null;

    function togglePopup() {
        const popup = document.getElementById("popup");
        const overlay = document.getElementById("overlay");
        if (popup.style.display === "block") {
            popup.style.display = "none";
            overlay.style.display = "none";
            resetPopup();
        } else {
            popup.style.display = "block";
            overlay.style.display = "block";
        }
    }

    function resetPopup() {
        document.getElementById("usernameInput").value = '';
        document.getElementById("emailInput").value = '';
        document.getElementById("popupTitle").textContent = "Create User";
        editingUserId = null;
    }

    function openEditPopup(id, username, email) {
        document.getElementById("usernameInput").value = username;
        document.getElementById("emailInput").value = email;
        document.getElementById("popupTitle").textContent = "Update User";
        editingUserId = id;
        togglePopup();
    }

    async function addOrUpdateUser() {
        const username = document.getElementById("usernameInput").value;
        const email = document.getElementById("emailInput").value;

        if (editingUserId) {
            const response = await fetch(`/admin/update-user/${editingUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email })
            });

            if (response.ok) {
                const updatedUser = await response.json();
                document.querySelector(`#user-${editingUserId} td:nth-child(2)`).textContent = updatedUser.username;
                document.querySelector(`#user-${editingUserId} td:nth-child(3)`).textContent = updatedUser.email;
                alert("User updated!");
            } else {
                const errorData = await response.json();
                alert(`Failed to update user: ${errorData.message || "Unknown error"}`);
            }
        } else {
            const response = await fetch(`/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email })
            });

            if (response.ok) {
                const newUser = await response.json();
                const newRow = document.createElement("tr");
                newRow.id = `user-${newUser._id}`;
                newRow.innerHTML = `
                <td>${newUser._id}</td>
                <td class="username">${newUser.username}</td>
                <td class="email">${newUser.email}</td>
                <td><button class="edit" onclick="openEditPopup('${newUser._id}', '${newUser.username}', '${newUser.email}')">Edit</button></td>
                <td><button class="delete" onclick="deleteUser('${newUser._id}')">Delete</button></td>
            `;
                document.getElementById("userTableBody").appendChild(newRow);
                alert("User added!");
            } else {
                const errorData = await response.json();
                alert(`Failed to add user: ${errorData.message || "Unknown error"}`);
            }
        }

        togglePopup();
    }


    async function deleteUser(id) {
        await fetch(`/admin/delete-user/${id}`, {
            method: 'DELETE'
        });
        const row = document.getElementById(`user-${id}`);
        if (row) row.remove();
        alert("User deleted!");
    }
</script>